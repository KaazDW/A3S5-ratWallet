{% extends 'base.html.twig' %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('assets/css/pages/dashboard.css') }}">
{% endblock %}

{% block body %}
    <section class="dashboard">
        <div class="element">
            <p>dashboard</p>
        </div>
        <div class="element">
            <p>Top 3 des comptes les plus riches :</p>
            <ul>
                {% for topAccount in topAccounts %}
                    <li>{{ topAccount.userID.username }} -> {{ topAccount.nameAccount }} : {{ topAccount.balance }} €</li>
                {% endfor %}
            </ul>
        </div>
        <div class="element">
            {% if balanceSum is defined %}
                <p>{{ app.user.username }} voici la somme de chacun de vos comptes: {{ balanceSum }} €</p>
            {% else %}
                <p>{{ app.user.username }} vous n'avez aucun compte pour le moment.</p>
            {% endif %}
            {% if totalExpenseSum is defined %}
                <p>{{ app.user.username }} voici la somme des dépenses pour la totalité de vos comptes: {{ totalExpenseSum }} €</p>
            {% else %}
                <p>{{ app.user.username }} vous n'avez aucune dépense pour le moment.</p>
            {% endif %}

            {% if totalIncomeSum is defined %}
                <p>{{ app.user.username }} voici la somme des incomes pour la totalité de vos comptes: {{ totalIncomeSum }} €</p>
            {% else %}
                <p>{{ app.user.username }} vous n'avez aucun income pour le moment.</p>
            {% endif %}
        </div>
        <div class="element">
            {% if app.user.getNbAccount() is defined %}
                {% set nbAccountsCount = app.user.getNbAccount() %}
                {% if nbAccountsCount == 1 %}
                    <p>{{ app.user.username }} vous possédez 1 compte. Voici l'historique de votre solde :</p>
                    <div id="chartHistoryBalance"></div>
                {% elseif nbAccountsCount <= 3 %}
                    <p>{{ app.user.username }} vous possédez {{ nbAccountsCount }} comptes. Voici l'historique du solde pour chacun de vos comptes :</p>
                    <div id="chartHistoryBalance"></div>
                {% else %}
                    <p>{{ app.user.username }} vous ne possédez aucun compte.</p>
                {% endif %}
            {% endif %}
        </div>

        <div id="chartExpenseSumByCategory"></div>

    </section>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>

    document.addEventListener('DOMContentLoaded', function () {
        fetch("{{ path('datahistorybalance') }}")
            .then(response => response.json())
            .then(data => {
                if (data && data.length > 0) {
                    var options = {
                        chart: {
                            type: 'area',
                            height: 350
                        },
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            curve: 'smooth'
                        },
                        title: {
                            text: 'Progression par rapport à l\'objectif',
                            align: 'left',
                            style: {
                                fontSize: '14px'
                            }
                        },
                        xaxis: {
                            categories: data[0].amountHistory.map((_, index) => index + 1)
                        },
                        yaxis: {
                            tickAmount: 4,
                            labels: {
                                style: {
                                    colors: '#8e8da4',
                                },
                                offsetY: -7,
                                offsetX: 0,
                            },
                            axisBorder: {
                                show: false,
                            },
                            axisTicks: {
                                show: false
                            }
                        },
                        fill: {
                            opacity: 0.5
                        },
                        tooltip: {
                            x: {
                                format: "yyyy",
                            },
                            fixed: {
                                enabled: false,
                                position: 'topRight'
                            }
                        },
                        grid: {
                            yaxis: {
                                lines: {
                                    offsetX: -30
                                }
                            },
                            padding: {
                                left: 20
                            }
                        },
                        series: data.map(accountData => ({
                            name: accountData.accountName,
                            data: accountData.amountHistory
                        }))
                    };
                    var chart = new ApexCharts(document.querySelector('#chartHistoryBalance'), options);
                    chart.render();
                } else {
                    console.error('Les données de l\'historique sont incorrectes.');
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des données de l\'historique:', error);
            });
    });

    /*document.addEventListener('DOMContentLoaded', function () {
        {#fetch("{{ path('expenseSumByCategory') }}")
            .then(response => response.json())
            .then(data => {
                if (data && data.accountExpenseSums && data.accountExpenseSums.length > 0) {
                    var options = {
                        series: data.accountExpenseSums.map(accountData => ({
                            name: accountData.account.name,
                            data: accountData.expenseSums,
                        })),
                        chart: {
                            type: 'bar',
                            height: 350,
                            stacked: true,
                            toolbar: {
                                show: true
                            },
                            zoom: {
                                enabled: true
                            }
                        },
                        responsive: [{
                            breakpoint: 480,
                            options: {
                                legend: {
                                    position: 'bottom',
                                    offsetX: -10,
                                    offsetY: 0
                                }
                            }
                        }],
                        plotOptions: {
                            bar: {
                                horizontal: false,
                                borderRadius: 10,
                                dataLabels: {
                                    total: {
                                        enabled: true,
                                        style: {
                                            fontSize: '13px',
                                            fontWeight: 900
                                        }
                                    }
                                }
                            },
                        },
                        xaxis: {
                            categories: data.categories,
                        },
                        legend: {
                            position: 'right',
                            offsetY: 40
                        },
                        fill: {
                            opacity: 1
                        }
                    };

                    var chart = new ApexCharts(document.querySelector('#chartExpenseSumByCategory'), options);
                    chart.render();
                } else {
                    console.error('Les données de la somme des dépenses sont incorrectes.');
                }
            })
            .catch(error => {
                console.error('Erreur lors de la récupération des données de la somme des dépenses:', error);
            });
    #});*/


    /* document.addEventListener('DOMContentLoaded', function () {
{# fetch("{{ path('categoryAllAccount') }}") #}
            .then(response => response.json())
            .then(data => {

                if (data && data.length > 0) {
                    var options = {
                        chart: {
                            type: 'bar',
                            height: 350,
                            stacked: true,
                        },
                        stroke: {
                            width: 1,
                            colors: ['#fff']
                        },
                        dataLabels: {
                            formatter: (val) => {
                                return val / 1000 + 'K'
                            }
                        },
                        plotOptions: {
                            bar: {
                                horizontal: false
                            }
                        },
                        fill: {
                            opacity: 1
                        },
                        colors: ['#80c7fd', '#008FFB', '#80f1cb', '#00E396'],
                        yaxis: {
                            labels: {
                                formatter: (val) => {
                                    return val / 1000 + 'K'
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            horizontalAlign: 'left'
                        }
                    };

                    // Transform your data to fit the series structure
                    var series = [];
                    data.forEach(function (accountData) {
                        accountData.expenseSums.forEach(function (expenseSum, index) {
                            var categorySeries = {
                                name: accountData.account.name + ' - ' + 'Q' + (index + 1) + ' ' + accountData.expenseSums[index].group,
                                group: accountData.expenseSums[index].group.toLowerCase(),
                                data: expenseSum
                            };

                            series.push(categorySeries);
                        });
                    });

                    options.series = series;

                    var chart = new ApexCharts(document.querySelector("#chartCategoryAllAccount"), options);
                    chart.render();
                }
            }});
    });
*/



    </script>

{% endblock %}
